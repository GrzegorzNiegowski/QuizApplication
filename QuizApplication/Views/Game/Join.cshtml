@model QuizApplication.DTOs.GameDtos.JoinGameDto
@{
    ViewData["Title"] = "Dołącz do gry";
    Layout = "_GameLayout";
}

<div class="join-container d-flex align-items-center justify-content-center min-vh-100">
    <div class="join-card w-100">
        <h1 class="join-title">
            <i class="bi bi-controller"></i> Dołącz do Quizu
        </h1>

        <form id="joinForm">
            <div class="mb-4">
                <label class="form-label text-white-50">Kod gry</label>
                <input type="text"
                       id="accessCode"
                       name="AccessCode"
                       class="form-control code-input"
                       placeholder="XXXXX"
                       maxlength="5"
                       value="@Model.AccessCode"
                       autocomplete="off"
                       required />
                <div id="codeValidation" class="form-text"></div>
            </div>

            <div class="mb-4">
                <label class="form-label text-white-50">Twój nick</label>
                <input type="text"
                       id="nickname"
                       name="Nickname"
                       class="form-control nick-input"
                       placeholder="Wpisz swój nick..."
                       minlength="2"
                       maxlength="20"
                       value="@Model.Nickname"
                       required />
                <div class="form-text text-white-50">2-20 znaków, litery, cyfry i _</div>
            </div>

            <div id="gameInfo" class="mb-4 d-none">
                <div class="alert alert-info bg-transparent border border-info text-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <span id="gameInfoText"></span>
                </div>
            </div>

            <div id="errorMessage" class="mb-4 d-none">
                <div class="alert alert-danger bg-transparent border border-danger text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="errorText"></span>
                </div>
            </div>

            <button type="submit" id="joinBtn" class="btn btn-join w-100" disabled>
                <i class="bi bi-box-arrow-in-right me-2"></i>
                Dołącz
            </button>
        </form>

        <div class="text-center mt-4">
            <a href="/" class="text-white-50 text-decoration-none">
                <i class="bi bi-arrow-left me-1"></i> Powrót do strony głównej
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const accessCodeInput = document.getElementById('accessCode');
        const nicknameInput = document.getElementById('nickname');
        const joinBtn = document.getElementById('joinBtn');
        const joinForm = document.getElementById('joinForm');
        const codeValidation = document.getElementById('codeValidation');
        const gameInfo = document.getElementById('gameInfo');
        const gameInfoText = document.getElementById('gameInfoText');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        let connection = null;
        let codeCheckTimeout = null;
        let isCodeValid = false;

        // Auto-uppercase dla kodu
        accessCodeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            checkCode();
        });

        // Walidacja nicku
        nicknameInput.addEventListener('input', () => {
            updateJoinButton();
        });

        function checkCode() {
            clearTimeout(codeCheckTimeout);
            const code = accessCodeInput.value;

            if (code.length !== 5) {
                isCodeValid = false;
                codeValidation.innerHTML = '';
                gameInfo.classList.add('d-none');
                updateJoinButton();
                return;
            }

            codeValidation.innerHTML = '<span class="text-info"><i class="bi bi-hourglass-split"></i> Sprawdzanie...</span>';

            codeCheckTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/Game/CheckCode?code=${code}`);
                    const result = await response.json();

                    if (result.valid) {
                        isCodeValid = true;
                        codeValidation.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Kod prawidłowy</span>';
                        gameInfoText.textContent = `Quiz: ${result.quizTitle} (${result.playerCount} graczy)`;
                        gameInfo.classList.remove('d-none');
                        errorMessage.classList.add('d-none');
                    } else {
                        isCodeValid = false;
                        codeValidation.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${result.message}</span>`;
                        gameInfo.classList.add('d-none');
                    }
                    updateJoinButton();
                } catch (error) {
                    codeValidation.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Błąd połączenia</span>';
                    isCodeValid = false;
                    updateJoinButton();
                }
            }, 500);
        }

        function updateJoinButton() {
            const nickname = nicknameInput.value.trim();
            const isNicknameValid = nickname.length >= 2 && nickname.length <= 20 && /^[a-zA-Z0-9_żźćńółęąśŻŹĆĄŚĘŁÓŃ]+$/.test(nickname);
            joinBtn.disabled = !isCodeValid || !isNicknameValid;
        }

        // Inicjalizacja SignalR
        async function initSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/quizHub")
                .withAutomaticReconnect()
                .build();

            await connection.start();
            console.log("SignalR Connected");
        }

        joinForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!connection) {
                await initSignalR();
            }

            joinBtn.disabled = true;
            joinBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Dołączanie...';

            try {
                const result = await connection.invoke("JoinGame", {
                    accessCode: accessCodeInput.value,
                    nickname: nicknameInput.value.trim()
                });

                if (result.success) {
                    // Przekieruj do lobby
                    window.location.href = `/Game/Lobby?sessionId=${result.sessionId}&playerId=${result.playerId}`;
                } else {
                    errorText.textContent = result.errorMessage || 'Nie udało się dołączyć do gry';
                    errorMessage.classList.remove('d-none');
                    joinBtn.disabled = false;
                    joinBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i> Dołącz';
                }
            } catch (error) {
                console.error('Join error:', error);
                errorText.textContent = 'Wystąpił błąd połączenia. Spróbuj ponownie.';
                errorMessage.classList.remove('d-none');
                joinBtn.disabled = false;
                joinBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i> Dołącz';
            }
        });

        // Sprawdź kod jeśli jest już wypełniony
        if (accessCodeInput.value.length === 5) {
            checkCode();
        }
    </script>
}
