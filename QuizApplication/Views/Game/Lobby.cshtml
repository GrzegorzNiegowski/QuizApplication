@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@

@{
    ViewData["Title"] = "Poczekalnia";
}
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<div class="text-center mt-5">
    <h1 class="display-4">Kod gry: <span class="text-primary">@ViewBag.Code</span></h1>
    <h3>Witaj, <strong>@ViewBag.Nick</strong>!</h3>
    <div class="spinner-border text-primary mt-3" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Czekamy na rozpoczęcie gry przez gospodarza...</p>

    <hr />
    <h4>Gracze w pokoju:</h4>
    <ul id="playersList" class="list-group list-group-flush mx-auto" style="max-width: 400px;">
    </ul>
</div>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/quizHub")
        .withAutomaticReconnect()
        .build();

    const code = "@ViewBag.Code";
    const nick = "@ViewBag.Nick";

    connection.on("UpdatePlayerList", function (players) {
        const list = document.getElementById("playersList");
        list.innerHTML = "";
        players.forEach(p => {
            const li = document.createElement("li");
            li.className = "list-group-item" + (p === nick ? " list-group-item-primary" : "");
            li.textContent = p + (p === nick ? " (Ty)" : "");
            list.appendChild(li);
        });
    });

    connection.on("GameStarted", function () {
        // Przekierowanie Gracza do ekranu gry
        // Kodujemy nick, żeby nie zgubić polskich znaków w URL
        window.location.href = `/Game/Play?code=${code}&nick=${encodeURIComponent(nick)}`;
    });

    connection.on("ShowError", function (msg) {
        alert(msg);
        window.location.href = "/Game/Join";
    });

    connection.start().then(function () {
        connection.invoke("JoinGamePlayer", code, nick).catch(err => console.error(err));
    }).catch(err => console.error(err));
</script>

@{
}
