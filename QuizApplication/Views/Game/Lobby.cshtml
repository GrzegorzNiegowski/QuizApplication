@{
    ViewData["Title"] = "Lobby";
    Layout = "_GameLayout";
    var sessionId = ViewBag.SessionId;
    var playerId = ViewBag.PlayerId;
    var quizTitle = ViewBag.QuizTitle;
    var accessCode = ViewBag.AccessCode;
    var nickname = ViewBag.Nickname;
    var isNewPlayer = ViewBag.IsNewPlayer ?? false;
}

<div class="lobby-container">
    <!-- Header -->
    <div class="mb-4">
        <h2 class="text-white-50 mb-2">Dołączono do:</h2>
        <h1 class="display-5 fw-bold text-white">@quizTitle</h1>
    </div>

    <!-- Kod gry -->
    <div class="mb-4">
        <p class="text-white-50 mb-1">Kod gry:</p>
        <div class="lobby-code">@accessCode</div>
    </div>

    <!-- Status połączenia -->
    <div id="connectionStatus" class="mb-3">
        <span class="badge bg-warning">
            <i class="bi bi-hourglass-split me-1"></i> Łączenie...
        </span>
    </div>

    <!-- Lista graczy -->
    <div class="mb-4">
        <h4 class="text-white-50">
            <i class="bi bi-people me-2"></i>
            Gracze (<span id="playerCount">0</span>)
        </h4>
        <div class="player-list" id="playerList">
            <div class="text-white-50">Ładowanie...</div>
        </div>
    </div>

    <!-- Oczekiwanie -->
    <div class="waiting-message">
        <i class="bi bi-hourglass-split waiting-spinner"></i>
        Oczekiwanie na rozpoczęcie gry przez hosta...
    </div>

    <!-- Przycisk wyjścia -->
    <div class="mt-4">
        <button class="btn btn-cancel" onclick="leaveGame()">
            <i class="bi bi-box-arrow-left me-2"></i> Opuść grę
        </button>
    </div>
</div>

@section Scripts {
    <script>
        const accessCode = '@accessCode';
        const nickname = '@(nickname ?? "")';
        const isNewPlayer = @(isNewPlayer.ToString().ToLower());

        let sessionId = '@(sessionId ?? Guid.Empty)';
        let playerId = '@(playerId ?? "")';
        let connection = null;
        const players = new Map();

        async function initLobby() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/quizHub")
                .withAutomaticReconnect()
                .build();

            // Event handlers
            connection.on("PlayerEvent", handlePlayerEvent);
            connection.on("GameStarted", handleGameStarted);
            connection.on("GameCancelled", handleGameCancelled);
            connection.on("GameMessage", handleMessage);

            connection.onreconnecting(() => {
                updateConnectionStatus('warning', 'Ponowne łączenie...');
            });

            connection.onreconnected(async () => {
                updateConnectionStatus('info', 'Ponowne dołączanie...');
                await rejoinGame();
            });

            connection.onclose(() => {
                updateConnectionStatus('danger', 'Rozłączono');
            });

            try {
                await connection.start();
                console.log("SignalR connected");

                if (isNewPlayer && nickname) {
                    // Nowy gracz - dołącz do gry
                    await joinGame();
                } else if (playerId) {
                    // Powracający gracz - reconnect
                    await rejoinGame();
                } else {
                    // Tylko pobierz info o lobby
                    await loadLobbyInfo();
                }
            } catch (error) {
                console.error("Connection error:", error);
                updateConnectionStatus('danger', 'Błąd połączenia');
            }
        }

        async function joinGame() {
            updateConnectionStatus('info', 'Dołączanie...');

            try {
                console.log("Wywołuję JoinGame z:", { accessCode, nickname });

                const result = await connection.invoke("JoinGame", {
                    accessCode: accessCode,
                    nickname: nickname
                });

                console.log("JoinGame result:", result);

                if (result.success) {
                    sessionId = result.sessionId;
                    playerId = result.playerId;
                    updateConnectionStatus('success', 'Połączono');

                    // Zapisz dane do localStorage dla reconnectu
                    localStorage.setItem('quizSessionId', sessionId);
                    localStorage.setItem('quizPlayerId', playerId);
                    localStorage.setItem('quizNickname', nickname);
                    localStorage.setItem('quizAccessCode', accessCode);

                    console.log("Dołączono do gry:", { sessionId, playerId });

                    // Pobierz listę graczy
                    await loadLobbyInfo();
                } else {
                    updateConnectionStatus('danger', result.errorMessage || 'Nie udało się dołączyć');
                    showToast(result.errorMessage || 'Nie udało się dołączyć do gry', 'error');
                }
            } catch (error) {
                console.error("Join error:", error);
                updateConnectionStatus('danger', 'Błąd dołączania');
                showToast('Błąd połączenia. Spróbuj odświeżyć stronę.', 'error');
            }
        }

        async function rejoinGame() {
            const savedNickname = localStorage.getItem('quizNickname') || nickname;

            if (!savedNickname) {
                updateConnectionStatus('danger', 'Brak danych do reconnectu');
                return;
            }

            try {
                const result = await connection.invoke("ReconnectGame", accessCode, savedNickname);

                if (result.success) {
                    sessionId = result.sessionId;
                    playerId = result.playerId;
                    updateConnectionStatus('success', 'Połączono');
                    await loadLobbyInfo();
                } else {
                    // Nie udało się reconnect - spróbuj jako nowy gracz
                    if (savedNickname) {
                        await joinGame();
                    }
                }
            } catch (error) {
                console.error("Reconnect error:", error);
            }
        }

        async function loadLobbyInfo() {
            try {
                const lobbyInfo = await connection.invoke("GetLobbyInfo", sessionId);
                if (lobbyInfo) {
                    lobbyInfo.players.forEach(p => {
                        players.set(p.playerId, {
                            nickname: p.nickname,
                            connected: p.isConnected
                        });
                    });
                    updatePlayerList();
                }
            } catch (error) {
                console.error("Load lobby error:", error);
            }
        }

        function handlePlayerEvent(event) {
            console.log("Player event:", event);

            switch (event.eventType) {
                case 'joined':
                    players.set(event.playerId, {
                        nickname: event.nickname,
                        connected: true
                    });
                    if (event.playerId !== playerId) {
                        showToast(`${event.nickname} dołączył`, 'info');
                    }
                    break;
                case 'left':
                    if (players.has(event.playerId)) {
                        showToast(`${players.get(event.playerId).nickname} opuścił grę`, 'warning');
                    }
                    players.delete(event.playerId);
                    break;
                case 'disconnected':
                    if (players.has(event.playerId)) {
                        players.get(event.playerId).connected = false;
                    }
                    break;
                case 'reconnected':
                    if (players.has(event.playerId)) {
                        players.get(event.playerId).connected = true;
                        showToast(`${event.nickname} powrócił`, 'info');
                    }
                    break;
            }

            updatePlayerList();
        }

        function handleGameStarted() {
            showToast('Gra się rozpoczyna!', 'success');

            // Wyczyść localStorage
            localStorage.removeItem('quizSessionId');
            localStorage.removeItem('quizPlayerId');

            setTimeout(() => {
                window.location.href = `/Game/Play?sessionId=${sessionId}&playerId=${playerId}`;
            }, 500);
        }

        function handleGameCancelled(message) {
            showToast(message.message, 'error');
            localStorage.clear();
            setTimeout(() => {
                window.location.href = '/Game/Join';
            }, 2000);
        }

        function handleMessage(message) {
            showToast(message.message, message.type);
        }

        function updatePlayerList() {
            const list = document.getElementById('playerList');
            const count = document.getElementById('playerCount');

            count.textContent = players.size;

            if (players.size === 0) {
                list.innerHTML = '<div class="text-white-50">Brak graczy</div>';
                return;
            }

            let html = '';
            players.forEach((player, id) => {
                const disconnectedClass = player.connected ? '' : 'disconnected';
                const isYou = id === playerId ? ' (Ty)' : '';
                const initial = player.nickname.charAt(0).toUpperCase();
                html += `
                    <div class="player-card ${disconnectedClass}">
                        <div class="player-avatar">${initial}</div>
                        <span>${player.nickname}${isYou}</span>
                        ${!player.connected ? '<i class="bi bi-wifi-off text-warning ms-2"></i>' : ''}
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function updateConnectionStatus(type, text) {
            const status = document.getElementById('connectionStatus');
            const icon = type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : 'hourglass-split';
            status.innerHTML = `<span class="badge bg-${type}"><i class="bi bi-${icon} me-1"></i> ${text}</span>`;
        }

        async function leaveGame() {
            if (!confirm('Czy na pewno chcesz opuścić grę?')) return;

            try {
                if (connection && playerId) {
                    await connection.invoke("LeaveGame", sessionId, playerId);
                }
            } catch (error) {
                console.error("Leave error:", error);
            }

            localStorage.clear();
            window.location.href = '/Game/Join';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `game-toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Init
        initLobby();
    </script>
}
