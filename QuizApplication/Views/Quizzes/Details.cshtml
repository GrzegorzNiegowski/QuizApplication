@model QuizApplication.DTOs.QuizDtos.QuizDetailsDto
@{
    ViewData["Title"] = Model.Title;
    bool canEdit = User.Identity?.IsAuthenticated == true &&
        (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.OwnerId
         || User.IsInRole("Admin"));
}

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
            <h1 class="mb-2">@Model.Title</h1>
            <div class="text-muted">
                Kod dostępu:
                <span class="badge bg-primary fs-5 user-select-all">@Model.AccessCode</span>
            </div>
        </div>
        @if (canEdit)
        {
            <div class="d-flex gap-2">
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
                    Zmień tytuł
                </a>
                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger">
                    Usuń quiz
                </a>
            </div>
        }
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="row text-center">
            <div class="col">
                <h3 class="text-primary mb-0">@Model.Questions.Count</h3>
                <small class="text-muted">Pytań</small>
            </div>
            <div class="col">
                <h3 class="text-success mb-0">@Model.Questions.Sum(q => q.Points)</h3>
                <small class="text-muted">Suma punktów</small>
            </div>
            <div class="col">
                <h3 class="text-info mb-0">@Model.Questions.Sum(q => q.TimeLimitSeconds)s</h3>
                <small class="text-muted">Całkowity czas</small>
            </div>
        </div>
    </div>
</div>

@if (canEdit)
{
    <div class="mb-4">
        <a asp-controller="Questions" asp-action="Create" asp-route-quizId="@Model.Id"
           class="btn btn-success btn-lg">
            Dodaj nowe pytanie
        </a>
    </div>
}

<h3 class="mb-3">Lista pytań</h3>

@if (!Model.Questions.Any())
{
    <div class="alert alert-info">
        <strong>Ten quiz nie ma jeszcze żadnych pytań.</strong>
        <br />Kliknij przycisk powyżej, aby dodać pierwsze pytanie.
    </div>
}
else
{
    <div class="row">
        @foreach (var (question, index) in Model.Questions.Select((q, i) => (q, i + 1)))
        {
            <div class="col-12 mb-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <strong>Pytanie @index</strong>
                        <div>
                            <span class="badge bg-info">@question.TimeLimitSeconds s</span>
                            <span class="badge bg-warning text-dark">⭐ @question.Points pkt</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title mb-3">@question.Content</h5>

                        @if (!string.IsNullOrEmpty(question.ImageUrl))
                        {
                            <p class="text-muted small">Zawiera obrazek</p>
                        }

                        <div class="row">
                            @foreach (var answer in question.Answers)
                            {
                                <div class="col-md-6 mb-2">
                                    <div class="p-2 rounded border @(answer.IsCorrect ? "border-success bg-success bg-opacity-10" : "")">
                                        @if (answer.IsCorrect)
                                        {
                                            <span class="text-success fw-bold">✓</span>
                                        }
                                        @answer.Content
                                    </div>
                                </div>
                            }
                        </div>

                        @if (canEdit)
                        {
                            <div class="mt-3 pt-3 border-top">
                                <a asp-controller="Questions" asp-action="Edit" asp-route-id="@question.Id"
                                   class="btn btn-sm btn-outline-primary">
                                    Edytuj
                                </a>
                                <a asp-controller="Questions" asp-action="Delete" asp-route-id="@question.Id"
                                   class="btn btn-sm btn-outline-danger">
                                    Usuń
                                </a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<div class="mt-4">
    <a asp-action="Index" class="btn btn-secondary">
        Wróć do listy quizów
    </a>
</div>
